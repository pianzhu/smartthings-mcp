# SmartThings Agent å®ç°å®Œæ•´æ–‡æ¡£

**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶é€šè¿‡æµ‹è¯•
**å®ç°æ—¥æœŸ**: 2025-11-14
**æœ€åæ›´æ–°**: 2025-11-14 (ç®€åŒ–ä¸ºè®¾å¤‡æ§åˆ¶ä¸“ç”¨)
**æµ‹è¯•è¦†ç›–**: 5 ä¸ªæµ‹è¯•åœºæ™¯ï¼Œå…¨éƒ¨é€šè¿‡

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒç›®æ ‡ä¸å®Œæˆæ ‡å‡†](#æ ¸å¿ƒç›®æ ‡ä¸å®Œæˆæ ‡å‡†)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [å®æ–½æ£€æŸ¥æ¸…å•](#å®æ–½æ£€æŸ¥æ¸…å•)
5. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
6. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [æ–‡ä»¶æ¸…å•](#æ–‡ä»¶æ¸…å•)

---

## æ ¸å¿ƒç›®æ ‡ä¸å®Œæˆæ ‡å‡†

### è®¾è®¡ç†å¿µï¼šä¸“æ³¨è®¾å¤‡æ§åˆ¶

**å…³é”®å†³ç­–**: æ‰€æœ‰ç”¨æˆ·è¯·æ±‚éƒ½æ˜¯è®¾å¤‡æ§åˆ¶å‘½ä»¤ï¼Œæ— éœ€å¤æ‚çš„æ„å›¾åˆ†ç±»ç³»ç»Ÿã€‚

#### âœ… 1. ç®€åŒ–çš„ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Context Layer (Cached)                       â”‚
â”‚  - System Prompt (è®¾å¤‡æ§åˆ¶ä¸“ç”¨æŒ‡å—)                     â”‚
â”‚  - Tool Descriptions (3ä¸ªæ ¸å¿ƒå·¥å…·)                       â”‚
â”‚  Token: ~1000 | Cache Hit Rate: 95%                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Planning Layer (Lightweight)                 â”‚
â”‚  - Device Query Extraction (æå–è®¾å¤‡æŸ¥è¯¢)               â”‚
â”‚  - Command Interpretation Check (åˆ¤æ–­æ˜¯å¦éœ€è¦è§£é‡Š)      â”‚
â”‚  - Multi-Device Detection (å¤šè®¾å¤‡æ£€æµ‹)                  â”‚
â”‚  Token: ~300-500                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Execution Layer (MCP Tools)                  â”‚
â”‚  - search_devices â†’ interpret_command â†’ execute        â”‚
â”‚  - ç»Ÿä¸€çš„3æ­¥å·¥ä½œæµ                                       â”‚
â”‚  Token: ~500-1000                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°çŠ¶æ€**: âœ… å®Œæˆå¹¶ç®€åŒ–
- `prompts.py`: è®¾å¤‡æ§åˆ¶ä¸“ç”¨ç³»ç»Ÿæç¤ºè¯
- `planner.py`: DeviceControlPlanner (ç§»é™¤æ„å›¾åˆ†ç±»)
- `client.py`: å·¥å…·ç¼–æ’ (å¯é€‰ï¼Œç®€åŒ–åœºæ™¯å¯ç›´æ¥è°ƒç”¨ MCP)

#### âœ… 2. Prompt Engineering ç­–ç•¥

**ç®€åŒ–åçš„è¦æ±‚**:
- System Prompt ä¸“æ³¨è®¾å¤‡æ§åˆ¶å·¥ä½œæµ
- æ˜ç¡®3æ­¥æµç¨‹ï¼šsearch â†’ interpret (å¯é€‰) â†’ execute
- æ¸…æ™°çš„å·¥å…·ä½¿ç”¨è§„åˆ™

**å®ç°çŠ¶æ€**: âœ… å®Œæˆå¹¶ç®€åŒ–
- `prompts.py::AGENT_SYSTEM_PROMPT`: è®¾å¤‡æ§åˆ¶ä¸“ç”¨æç¤ºè¯ (~90è¡Œ)
- ç§»é™¤äº† QUERY/ANALYSIS/DISCOVERY ç›¸å…³æŒ‡å¯¼
- ä¸“æ³¨äºæ˜ç¡®å‘½ä»¤ vs æ¨¡ç³Šå‘½ä»¤çš„å¤„ç†

#### âœ… 3. å·¥ä½œæµè§„åˆ’ï¼ˆç®€åŒ–ï¼‰

**ä¹‹å‰**: 5ç§æ„å›¾ç±»å‹ï¼Œ9ç§å·¥ä½œæµæ¨¡å¼
**ç°åœ¨**: ä¸“æ³¨è®¾å¤‡æ§åˆ¶ï¼Œç»Ÿä¸€å·¥ä½œæµ

**å®ç°çŠ¶æ€**: âœ… ç®€åŒ–å®Œæˆ
- ç§»é™¤ `IntentRecognizer` å’Œ `Intent` enum
- ç§»é™¤ `WorkflowPlanner` å¤æ‚å†³ç­–æ ‘
- æ–°å¢ `DeviceControlPlanner`:
  - æå–è®¾å¤‡æŸ¥è¯¢
  - æ£€æµ‹å¤šè®¾å¤‡æ“ä½œ
  - åˆ¤æ–­æ˜¯å¦éœ€è¦å‘½ä»¤è§£é‡Š
  - å»ºè®®æ‰¹å¤„ç† vs å¹¶è¡Œæ‰§è¡Œ

#### âœ… 4. ä¸Šä¸‹æ–‡æ„ŸçŸ¥è§„åˆ’

**è¦æ±‚**:
- Short-Term Memory (å¯¹è¯å†…è®¾å¤‡ç¼“å­˜)
- Device ID é‡ç”¨æœºåˆ¶
- æˆ¿é—´ä¸Šä¸‹æ–‡æ¨æ–­

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ
- `context_manager.py::ConversationContext`: å®Œæ•´çš„ä¸Šä¸‹æ–‡ç®¡ç†
  - è®¾å¤‡ç¼“å­˜ (DeviceMemory)
  - çŠ¶æ€ç¼“å­˜ (TTL: 5åˆ†é’Ÿ)
  - ä»£è¯å¼•ç”¨è§£æ ("å®ƒ" â†’ æœ€è¿‘æåˆ°çš„è®¾å¤‡)
  - æˆ¿é—´æ¨æ–­ (ä»ç”¨æˆ·è¾“å…¥æå–)

#### âœ… 5. å¹¶è¡Œä¸ä¸²è¡Œæ‰§è¡Œç­–ç•¥

**è¦æ±‚**: å¤šè®¾å¤‡æ“ä½œæ™ºèƒ½å†³ç­–

**å®ç°çŠ¶æ€**: âœ… ä¿æŒ
- 2-3 è®¾å¤‡ â†’ å¹¶è¡Œ execute_commands
- 4+ è®¾å¤‡ â†’ batch_execute_commands
- `DeviceControlPlanner.should_use_batch()` æä¾›å»ºè®®

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ
- `planner.py::detect_multi_device_operation`: æ£€æµ‹å¤šè®¾å¤‡æ“ä½œ
- `planner.py::should_use_batch`: æ‰¹å¤„ç†å†³ç­–

#### âœ… 6. é”™è¯¯å¤„ç†ä¸æ¢å¤

**è¦æ±‚**:
- ä¼˜é›…é™çº§ç­–ç•¥
- Fallback æœºåˆ¶
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ
- `error_handler.py::ErrorHandler`: 6 ç§é”™è¯¯ç±»å‹å¤„ç†
- `error_handler.py::FallbackStrategy`: 3 ç§é™çº§ç­–ç•¥
  - Device not found â†’ æ‰©å¤§æœç´¢èŒƒå›´
  - Command not supported â†’ æŸ¥è¯¢å¯ç”¨å‘½ä»¤
  - Parameter invalid â†’ å‚æ•°æ ¡æ­£

### å®æ–½æ£€æŸ¥æ¸…å•ï¼ˆç®€åŒ–åï¼‰

ç®€åŒ–åçš„ Agent ç³»ç»Ÿæ£€æŸ¥æ¸…å•ï¼š

- [x] System Prompt ä¸“æ³¨è®¾å¤‡æ§åˆ¶å·¥ä½œæµ
- [x] æ ¸å¿ƒå·¥å…·ä½¿ç”¨æŒ‡å—ï¼ˆsearch_devices, interpret_command, execute_commandsï¼‰
- [x] å®ç°è®¾å¤‡æ§åˆ¶è§„åˆ’é€»è¾‘ï¼ˆDeviceControlPlannerï¼‰
- [x] å®ç°è®¾å¤‡ ID ç¼“å­˜æœºåˆ¶ï¼ˆConversationContextï¼‰
- [x] æ”¯æŒå¤šè®¾å¤‡å¹¶è¡Œ/æ‰¹å¤„ç†ï¼ˆshould_use_batchï¼‰
- [x] å®ç°é”™è¯¯å¤„ç†å’Œä¼˜é›…é™çº§ï¼ˆErrorHandlerï¼‰
- [x] ç¼–å†™è®¾å¤‡æ§åˆ¶è§„åˆ’æµ‹è¯•

**å®Œæˆåº¦**: 7/7 (100%)

**ç§»é™¤çš„é¡¹ç›®**:
- âŒ æ„å›¾è¯†åˆ«é€»è¾‘ï¼ˆIntentRecognizerï¼‰- æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯æ§åˆ¶å‘½ä»¤
- âŒ Token æ¶ˆè€—ç›‘æ§ - ç®€åŒ–åœºæ™¯ä¸éœ€è¦

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾ï¼ˆç®€åŒ–åï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     User (è‡ªç„¶è¯­è¨€è¾“å…¥)                      â”‚
â”‚                  "æ‰“å¼€å®¢å…çš„ç¯" / "è®©ç¯å…‰æŸ”å’Œä¸€äº›"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SmartThingsAgent (ç®€åŒ–ç‰ˆ)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  client.py - ä¸»æ§åˆ¶å™¨ (å¯é€‰)                         â”‚  â”‚
â”‚  â”‚  - å¯¹è¯ç®¡ç†                                           â”‚  â”‚
â”‚  â”‚  - Claude API è°ƒç”¨                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚        â–¼            â–¼            â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Context â”‚ â”‚DeviceControl â”‚ â”‚  Error    â”‚               â”‚
â”‚  â”‚ Manager â”‚ â”‚   Planner    â”‚ â”‚  Handler  â”‚               â”‚
â”‚  â”‚         â”‚ â”‚              â”‚ â”‚           â”‚               â”‚
â”‚  â”‚ - Cache â”‚ â”‚ - Parse      â”‚ â”‚ - Fallbackâ”‚               â”‚
â”‚  â”‚ - Memoryâ”‚ â”‚ - Multi-Dev  â”‚ â”‚           â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  + prompts.py (è®¾å¤‡æ§åˆ¶ä¸“ç”¨ System Prompt)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Claude API (Anthropic SDK)                     â”‚
â”‚  - Model: claude-sonnet-4-5-20250929                        â”‚
â”‚  - Prompt Caching æ”¯æŒ                                      â”‚
â”‚  - ç»Ÿä¸€çš„è®¾å¤‡æ§åˆ¶å·¥ä½œæµ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MCP Server (SmartThings Integration)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ ¸å¿ƒå·¥å…· (3ä¸ª):                                      â”‚   â”‚
â”‚  â”‚  1. search_devices - æœç´¢è®¾å¤‡                        â”‚   â”‚
â”‚  â”‚  2. interpret_command - è§£ææ¨¡ç³Šå‘½ä»¤ (intent_mapper) â”‚   â”‚
â”‚  â”‚  3. execute_commands - æ‰§è¡Œæ§åˆ¶å‘½ä»¤                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SmartThings API                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„ç®€åŒ–è¯´æ˜**:
- âŒ ç§»é™¤: Intent enum, IntentRecognizer, WorkflowPlanner
- âœ… ä¿ç•™: Context Manager, Error Handler
- âœ… ç®€åŒ–: DeviceControlPlanner ä¸“æ³¨è®¾å¤‡æ§åˆ¶è§£æ
- âœ… ç»Ÿä¸€: æ‰€æœ‰è¯·æ±‚ä½¿ç”¨ search â†’ interpret (å¯é€‰) â†’ execute å·¥ä½œæµ

### æ•°æ®æµç¤ºä¾‹ï¼ˆç®€åŒ–åï¼‰

**åœºæ™¯ 1**: ç”¨æˆ·è¯´ "æ‰“å¼€å®¢å…çš„ç¯"ï¼ˆæ˜ç¡®å‘½ä»¤ï¼‰

```
1. User Input â†’ Agent
   "æ‰“å¼€å®¢å…çš„ç¯"

2. Agent â†’ DeviceControlPlanner
   parse_control_request("æ‰“å¼€å®¢å…çš„ç¯")
   â†’ DeviceControlPlan(
       device_query="å®¢å… ç¯",
       command_text="æ‰“å¼€å®¢å…çš„ç¯",
       is_multi_device=False,
       device_count=1,
       requires_interpret=False
     )

3. Agent â†’ Claude API
   System Prompt (è®¾å¤‡æ§åˆ¶ä¸“ç”¨) + User Message + MCP Tools

4. Claude â†’ MCP Server (Tool Call #1)
   search_devices(query="å®¢å… ç¯")

5. MCP â†’ Claude (Result #1)
   [{"fullId": "abc123", "name": "å®¢å…å¸é¡¶ç¯", "capabilities": ["switch", "switchLevel"], ...}]

6. Claude â†’ MCP Server (Tool Call #2)
   execute_commands(device_id="abc123", commands=[{capability: "switch", command: "on"}])
   âœ“ è·³è¿‡ interpret_commandï¼ˆæ˜ç¡®å‘½ä»¤ï¼‰

7. Response to User
   "å·²æ‰“å¼€å®¢å…å¸é¡¶ç¯"
```

**åœºæ™¯ 2**: ç”¨æˆ·è¯´ "è®©ç¯å…‰æŸ”å’Œä¸€äº›"ï¼ˆæ¨¡ç³Šå‘½ä»¤ï¼‰

```
1. User Input â†’ Agent
   "è®©ç¯å…‰æŸ”å’Œä¸€äº›"

2. Agent â†’ DeviceControlPlanner
   parse_control_request("è®©ç¯å…‰æŸ”å’Œä¸€äº›")
   â†’ DeviceControlPlan(
       device_query="ç¯å…‰ æŸ”å’Œä¸€äº›",
       command_text="è®©ç¯å…‰æŸ”å’Œä¸€äº›",
       is_multi_device=False,
       device_count=1,
       requires_interpret=True  â† éœ€è¦è§£é‡Š
     )

3. Claude â†’ MCP Server (Tool Call #1)
   search_devices(query="ç¯å…‰")

4. MCP â†’ Claude (Result #1)
   [{"fullId": "abc123", "capabilities": ["switch", "switchLevel"], ...}]

5. Claude â†’ MCP Server (Tool Call #2)
   interpret_command(
     user_input="æŸ”å’Œä¸€äº›",
     device_capabilities=["switch", "switchLevel"]
   )

6. MCP â†’ Claude (Result #2 - via intent_mapper)
   {
     "intent": "DECREASE_BRIGHTNESS",
     "capability": "switchLevel",
     "command": "setLevel",
     "arguments": [40],
     "confidence": 1.0
   }

7. Claude â†’ MCP Server (Tool Call #3)
   execute_commands(device_id="abc123", commands=[{
     capability: "switchLevel",
     command: "setLevel",
     arguments: [40]
   }])

8. Response to User
   "å·²å°†ç¯å…‰è°ƒæ•´åˆ° 40%ï¼ˆæŸ”å’Œäº®åº¦ï¼‰"
```

**å…³é”®å˜åŒ–**:
- âŒ ç§»é™¤: Intent recognition step (ä¸å†éœ€è¦åˆ¤æ–­ CONTROL/QUERY/ANALYSIS)
- âœ… ç®€åŒ–: ç»Ÿä¸€çš„ 3 æ­¥å·¥ä½œæµ
- âœ… ä¿ç•™: Context Manager çš„è®¾å¤‡ç¼“å­˜åŠŸèƒ½ï¼ˆåœºæ™¯å¤–ä½¿ç”¨ï¼‰

---

## æ ¸å¿ƒç»„ä»¶

### 1. Context Manager (`context_manager.py`)

**èŒè´£**: ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡å’Œè®¾å¤‡è®°å¿†

**æ ¸å¿ƒç±»**:

```python
class DeviceMemory:
    """å•ä¸ªè®¾å¤‡çš„è®°å¿†"""
    device_id: str
    name: str
    room: Optional[str]
    device_type: Optional[str]
    capabilities: List[str]
    last_mentioned_turn: int
    last_status: Optional[Dict]
    last_status_time: Optional[datetime]

class ConversationContext:
    """å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    mentioned_devices: Dict[str, DeviceMemory]
    current_room: Optional[str]
    current_turn: int
    last_intent: Optional[str]
```

**æ ¸å¿ƒåŠŸèƒ½**:

1. **è®¾å¤‡ç¼“å­˜**
   ```python
   context.add_device(
       device_id="abc123",
       name="å®¢å…å¸é¡¶ç¯",
       room="living room",
       capabilities=["switch", "switchLevel"]
   )
   ```

2. **ä»£è¯å¼•ç”¨è§£æ**
   ```python
   # Turn 1: "å®¢å…çš„ç¯"
   # Turn 2: "æŠŠå®ƒæ‰“å¼€"
   device = context.find_device_by_reference("å®ƒ")
   # â†’ Returns: DeviceMemory(id="abc123", name="å®¢å…å¸é¡¶ç¯")
   ```

3. **çŠ¶æ€ç¼“å­˜ (TTL: 5åˆ†é’Ÿ)**
   ```python
   context.update_device_status("abc123", {"switch": "on"})
   cached = context.get_cached_status("abc123")  # Fresh within 5 min
   ```

4. **æˆ¿é—´æ¨æ–­**
   ```python
   room = context.infer_room_from_input("æ‰“å¼€å®¢å…çš„ç¯")
   # â†’ "living room"
   ```

5. **è‡ªåŠ¨æ¸…ç†** (10è½®åé—å¿˜è®¾å¤‡)
   ```python
   context.cleanup_old_devices(turns_threshold=10)
   ```

---

### 2. Device Control Planner (`planner.py`)

**èŒè´£**: è®¾å¤‡æ§åˆ¶è¯·æ±‚è§£æå’Œå·¥ä½œæµå»ºè®®ï¼ˆç®€åŒ–ç‰ˆï¼‰

**æ ¸å¿ƒç±»**:

```python
@dataclass
class DeviceControlPlan:
    """è®¾å¤‡æ§åˆ¶è®¡åˆ’"""
    device_query: str         # è®¾å¤‡æœç´¢æŸ¥è¯¢
    command_text: str         # å‘½ä»¤æ–‡æœ¬
    is_multi_device: bool     # æ˜¯å¦å¤šè®¾å¤‡æ“ä½œ
    device_count: int         # ä¼°è®¡è®¾å¤‡æ•°é‡
    requires_interpret: bool  # æ˜¯å¦éœ€è¦å‘½ä»¤è§£é‡Š

class DeviceControlPlanner:
    """è®¾å¤‡æ§åˆ¶è§„åˆ’å™¨ - ä¸“æ³¨äºè®¾å¤‡æ§åˆ¶çš„ç®€åŒ–ç‰ˆæœ¬"""
    def parse_control_request(user_input: str) -> DeviceControlPlan
    def should_use_batch(device_count: int) -> bool
```

**æ ¸å¿ƒåŠŸèƒ½**:

1. **è®¾å¤‡æŸ¥è¯¢æå–**
   ```python
   # "æ‰“å¼€å®¢å…çš„ç¯" â†’ "å®¢å… ç¯"
   # "è®©å§å®¤çš„ç¯æŸ”å’Œä¸€äº›" â†’ "å§å®¤ ç¯ æŸ”å’Œä¸€äº›"
   device_query, command_text = planner._split_device_and_command(user_input)
   ```

2. **å¤šè®¾å¤‡æ£€æµ‹**
   ```python
   # "æ‰“å¼€å®¢å…çš„ç¯å’Œå§å®¤çš„ç©ºè°ƒ" â†’ (True, 2)
   # "æ‰“å¼€å®¢å…çš„ç¯" â†’ (False, 1)
   is_multi, count = planner._detect_multi_device(user_input)
   ```

3. **å‘½ä»¤è§£é‡Šéœ€æ±‚åˆ¤æ–­**
   ```python
   # "æ‰“å¼€" â†’ False (æ˜ç¡®å‘½ä»¤)
   # "æŸ”å’Œä¸€äº›" â†’ True (éœ€è¦è§£é‡Š)
   requires_interpret = planner._needs_interpretation(command_text)
   ```

**å·¥ä½œæµå»ºè®®ç¤ºä¾‹**:

```python
# åœºæ™¯ 1: å•è®¾å¤‡ + æ˜ç¡®å‘½ä»¤
plan = planner.parse_control_request("æ‰“å¼€å®¢å…çš„ç¯")
# DeviceControlPlan(
#   device_query="å®¢å… ç¯",
#   command_text="æ‰“å¼€å®¢å…çš„ç¯",
#   is_multi_device=False,
#   device_count=1,
#   requires_interpret=False
# )
# å»ºè®®å·¥ä½œæµ: search_devices â†’ execute_commands

# åœºæ™¯ 2: å•è®¾å¤‡ + æ¨¡ç³Šå‘½ä»¤
plan = planner.parse_control_request("è®©ç¯å…‰æŸ”å’Œä¸€äº›")
# DeviceControlPlan(
#   device_query="ç¯å…‰ æŸ”å’Œä¸€äº›",
#   command_text="è®©ç¯å…‰æŸ”å’Œä¸€äº›",
#   is_multi_device=False,
#   device_count=1,
#   requires_interpret=True
# )
# å»ºè®®å·¥ä½œæµ: search_devices â†’ interpret_command â†’ execute_commands

# åœºæ™¯ 3: å¤šè®¾å¤‡æ“ä½œ
plan = planner.parse_control_request("æ‰“å¼€å®¢å…çš„ç¯å’Œå§å®¤çš„ç©ºè°ƒ")
# DeviceControlPlan(
#   device_query=...,
#   is_multi_device=True,
#   device_count=2,
#   requires_interpret=False
# )
# å»ºè®®å·¥ä½œæµ: parallel search_devices â†’ parallel execute_commands
```

**ç§»é™¤çš„åŠŸèƒ½** (ç®€åŒ–å‰):
- âŒ Intent enum (CONTROL/QUERY/ANALYSIS/DISCOVERY/CONDITIONAL)
- âŒ IntentRecognizer - æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯è®¾å¤‡æ§åˆ¶
- âŒ WorkflowPlanner - ç»Ÿä¸€ä½¿ç”¨ 3 æ­¥å·¥ä½œæµ

---

### 3. Error Handler (`error_handler.py`)

**èŒè´£**: é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥

**é”™è¯¯ç±»å‹**:

```python
class ErrorType(Enum):
    DEVICE_NOT_FOUND = "device_not_found"
    COMMAND_NOT_SUPPORTED = "command_not_supported"
    PARAMETER_INVALID = "parameter_invalid"
    API_ERROR = "api_error"
    NETWORK_ERROR = "network_error"
    TIMEOUT = "timeout"
    PERMISSION_DENIED = "permission_denied"
```

**é™çº§ç­–ç•¥**:

| é”™è¯¯ç±»å‹ | Fallback ç­–ç•¥ | ç¤ºä¾‹ |
|---------|--------------|------|
| Device Not Found | æ‰©å¤§æœç´¢èŒƒå›´ | "å®¢å…çš„ç¯" â†’ "ç¯" |
| Command Not Supported | æŸ¥è¯¢å¯ç”¨å‘½ä»¤ | get_device_commands() |
| Parameter Invalid | å‚æ•°æ ¡æ­£/Clamp | 150% â†’ 100% |
| Network Error | é‡è¯• (max 3 æ¬¡) | å»¶è¿Ÿé‡è¯• |
| Permission Denied | é€šçŸ¥ç”¨æˆ· | "è¯·æ£€æŸ¥æƒé™" |

**ä½¿ç”¨ç¤ºä¾‹**:

```python
handler = ErrorHandler()

try:
    result = search_devices("ä¸å­˜åœ¨çš„è®¾å¤‡")
except Exception as e:
    error_response = handler.handle_error(e, context={...})
    # {
    #   "error": {...},
    #   "fallback": {"strategy": "broaden_search"},
    #   "user_message": "I couldn't find... Let me try a broader search"
    # }
```

---

### 4. Agent Client (`client.py`)

**èŒè´£**: ä¸»æ§åˆ¶å™¨ï¼Œåè°ƒæ‰€æœ‰ç»„ä»¶

**æ ¸å¿ƒåŠŸèƒ½**:

1. **å¯¹è¯ç®¡ç†**
   ```python
   agent = SmartThingsAgent(api_key="...", model="claude-sonnet-4-5-20250929")
   agent.set_mcp_tools(tools)
   response = agent.chat("æ‰“å¼€å®¢å…çš„ç¯", mcp_executor=executor)
   ```

2. **Claude API è°ƒç”¨**
   - System prompt with caching
   - Multi-turn conversation
   - Tool use orchestration

3. **è‡ªåŠ¨ä¸Šä¸‹æ–‡æ›´æ–°**
   - search_devices ç»“æœ â†’ add_device()
   - get_device_status ç»“æœ â†’ update_device_status()
   - æˆ¿é—´æ¨æ–­ â†’ current_room

4. **Token è¿½è¸ª**
   ```python
   usage = agent.get_token_usage()
   # {
   #   "total_input_tokens": 1500,
   #   "total_output_tokens": 300,
   #   "cache_read_tokens": 1200,  # Prompt caching!
   #   "total_tokens": 1800
   # }
   ```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è¦†ç›–

**æ–‡ä»¶**: `test/test_device_control_planner.py`

âœ… **5 ä¸ªæµ‹è¯•åœºæ™¯å…¨éƒ¨é€šè¿‡**:

1. **test_device_query_extraction** (4/4)
   - ä»è‡ªç„¶è¯­è¨€æå–è®¾å¤‡æŸ¥è¯¢
   - "æ‰“å¼€å®¢å…çš„ç¯" â†’ "å®¢å… ç¯"
   - "è®©å§å®¤çš„ç¯æŸ”å’Œä¸€äº›" â†’ "å§å®¤ ç¯ æŸ”å’Œä¸€äº›"

2. **test_multi_device_detection** (4 åœºæ™¯)
   - å•è®¾å¤‡æ£€æµ‹: "æ‰“å¼€å®¢å…çš„ç¯" â†’ (False, 1)
   - å¤šè®¾å¤‡æ£€æµ‹: "æ‰“å¼€å®¢å…çš„ç¯å’Œå§å®¤çš„ç©ºè°ƒ" â†’ (True, 2)
   - 3è®¾å¤‡æ£€æµ‹: "æ‰“å¼€å®¢å…çš„ç¯ï¼Œå…³é—­å§å®¤çš„ç©ºè°ƒï¼Œé”ä¸Šå‰é—¨" â†’ (True, 3)
   - æ‰¹å¤„ç†å†³ç­–: 4+ è®¾å¤‡ â†’ use batch_execute_commands

3. **test_command_interpretation_check** (7/7)
   - æ˜ç¡®å‘½ä»¤ä¸éœ€è¦è§£é‡Š: "æ‰“å¼€å®¢å…çš„ç¯" â†’ False
   - æ¨¡ç³Šå‘½ä»¤éœ€è¦è§£é‡Š: "è®©ç¯å…‰æŸ”å’Œä¸€äº›" â†’ True
   - åŒ…å«æ•°å­—çš„å‘½ä»¤ä¸éœ€è¦è§£é‡Š: "æŠŠç¯è°ƒåˆ°50%" â†’ False

4. **test_complete_parsing** (3 åœºæ™¯)
   - å•è®¾å¤‡ + æ˜ç¡®å‘½ä»¤
   - å•è®¾å¤‡ + æ¨¡ç³Šå‘½ä»¤
   - å¤šè®¾å¤‡ + æ˜ç¡®å‘½ä»¤

5. **test_workflow_recommendation**
   - åœºæ™¯1: å•è®¾å¤‡ + æ˜ç¡®å‘½ä»¤ â†’ 2æ­¥å·¥ä½œæµ
   - åœºæ™¯2: å•è®¾å¤‡ + æ¨¡ç³Šå‘½ä»¤ â†’ 3æ­¥å·¥ä½œæµ
   - åœºæ™¯3: å¤šè®¾å¤‡(2-3ä¸ª) â†’ å¹¶è¡Œæ‰§è¡Œ
   - åœºæ™¯4: å¤šè®¾å¤‡(4+ä¸ª) â†’ æ‰¹å¤„ç†æ‰§è¡Œ

**é¢å¤–æµ‹è¯•**: `test/test_context_manager.py` å’Œ `test/test_error_handler.py` æµ‹è¯•ä¸Šä¸‹æ–‡ç®¡ç†å’Œé”™è¯¯å¤„ç†åŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰

### è¿è¡Œæµ‹è¯•

```bash
python test/test_device_control_planner.py
```

**è¾“å‡º**:
```
============================================================
ç®€åŒ–ç‰ˆè®¾å¤‡æ§åˆ¶è§„åˆ’å™¨æµ‹è¯•å¥—ä»¶
(ä¸“æ³¨äºè®¾å¤‡æ§åˆ¶ï¼Œæ— æ„å›¾åˆ†ç±»)
============================================================

éªŒè¯çš„èƒ½åŠ›:
  âœ“ è®¾å¤‡æŸ¥è¯¢æå–
  âœ“ å¤šè®¾å¤‡æ“ä½œæ£€æµ‹
  âœ“ å‘½ä»¤è§£é‡Šéœ€æ±‚åˆ¤æ–­
  âœ“ å®Œæ•´è¯·æ±‚è§£æ
  âœ“ å·¥ä½œæµå»ºè®®

ä¸“æ³¨ç‚¹:
  â€¢ æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯è®¾å¤‡æ§åˆ¶
  â€¢ æ— éœ€æ„å›¾åˆ†ç±» (CONTROL/QUERY/ANALYSIS)
  â€¢ ä½¿ç”¨ intent_mapper è§£ææ¨¡ç³Šå‘½ä»¤
  â€¢ ç®€åŒ–çš„å·¥ä½œæµè§„åˆ’
============================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
============================================================
```

---

## ä½¿ç”¨æŒ‡å—

### å®‰è£…ä¾èµ–

```bash
# æ·»åŠ  anthropic SDK åˆ°ä¾èµ–
uv pip install anthropic>=0.40.0

# æˆ–ä½¿ç”¨ uv syncï¼ˆä¼šè‡ªåŠ¨å®‰è£…æ‰€æœ‰ä¾èµ–ï¼‰
uv sync
```

### åŸºæœ¬ä½¿ç”¨

```python
from agent import SmartThingsAgent

# 1. åˆå§‹åŒ– Agent
agent = SmartThingsAgent(
    api_key="your-anthropic-api-key",
    model="claude-sonnet-4-5-20250929"
)

# 2. è®¾ç½® MCP å·¥å…· (from MCP server)
agent.set_mcp_tools(mcp_tools)

# 3. å®šä¹‰ MCP æ‰§è¡Œå™¨
def mcp_executor(tool_name, parameters):
    # è°ƒç”¨å®é™…çš„ MCP æœåŠ¡å™¨
    return mcp_client.call_tool(tool_name, parameters)

# 4. å¼€å§‹å¯¹è¯
response = agent.chat("æˆ‘æœ‰å“ªäº›è®¾å¤‡ï¼Ÿ", mcp_executor=mcp_executor)
print(response)

# 5. ç»§ç»­å¯¹è¯ (åˆ©ç”¨ä¸Šä¸‹æ–‡)
response = agent.chat("æ‰“å¼€å®¢å…çš„ç¯", mcp_executor=mcp_executor)
response = agent.chat("æŠŠå®ƒè°ƒåˆ°50%", mcp_executor=mcp_executor)  # "å®ƒ" è‡ªåŠ¨è¯†åˆ«

# 6. æŸ¥çœ‹ç»Ÿè®¡
print(agent.get_token_usage())
print(agent.get_context_summary())
```

### å®Œæ•´ç¤ºä¾‹

æŸ¥çœ‹ `examples/agent_example.py` è·å–å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹ã€‚

è¿è¡Œç¤ºä¾‹:
```bash
export ANTHROPIC_API_KEY='your-key'
python examples/agent_example.py
```

---

## æ€§èƒ½ä¼˜åŒ–

### Token ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–ç­–ç•¥ | å®ç°ä½ç½® | æ•ˆæœ |
|---------|---------|------|
| **Prompt Caching** | client.py | ~95% cache hit rate |
| **è®¾å¤‡ ID ç¼“å­˜** | context_manager.py | å‡å°‘ search_devices è°ƒç”¨ |
| **çŠ¶æ€ç¼“å­˜ (5min TTL)** | context_manager.py | å‡å°‘ get_device_status è°ƒç”¨ |
| **å·¥ä½œæµä¼˜åŒ–** | planner.py | æ™ºèƒ½è·³è¿‡ä¸å¿…è¦æ­¥éª¤ |
| **æ‰¹å¤„ç†** | planner.py | 4+ è®¾å¤‡ç”¨ batch_execute |

### å®é™…æ•ˆæœå¯¹æ¯”

**åœºæ™¯**: 4 è½®å¯¹è¯ - "æ‰¾è®¾å¤‡" â†’ "æ§åˆ¶" â†’ "æŸ¥è¯¢" â†’ "å†æŸ¥è¯¢"

| è½®æ¬¡ | ä¼ ç»Ÿæ–¹å¼ | ä¼˜åŒ–å Agent | èŠ‚çœ |
|-----|---------|-------------|------|
| Turn 1 | search + execute (2 calls) | search + execute (2 calls) | 0% |
| Turn 2 | search + execute (2 calls) | execute (1 call) | **50%** |
| Turn 3 | search + get_status (2 calls) | get_status (1 call) | **50%** |
| Turn 4 | get_status (1 call) | 0 calls (cached) | **100%** |
| **æ€»è®¡** | **7 API calls** | **4 API calls** | **43%** |

åŠ ä¸Š Prompt Caching çš„é¢å¤–èŠ‚çœ:
- æ¯è½® ~2000 tokens system prompt â†’ ç¼“å­˜å ~50 tokens
- **é¢å¤–èŠ‚çœ ~97.5% çš„ system prompt tokens**

---

## æ–‡ä»¶æ¸…å•

### Agent æ ¸å¿ƒæ–‡ä»¶ (ç®€åŒ–å)

```
src/agent/
â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ– (å¯¼å‡º DeviceControlPlanner)
â”œâ”€â”€ client.py                # ä¸» Agent å®¢æˆ·ç«¯ (260 è¡Œ) - å¯é€‰
â”œâ”€â”€ context_manager.py       # ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (280 è¡Œ)
â”œâ”€â”€ planner.py               # è®¾å¤‡æ§åˆ¶è§„åˆ’å™¨ (142 è¡Œ) â¬‡ -238 è¡Œ
â”œâ”€â”€ error_handler.py         # é”™è¯¯å¤„ç†å™¨ (280 è¡Œ)
â””â”€â”€ prompts.py               # ç³»ç»Ÿæç¤ºè¯ (113 è¡Œ) â¬‡ -67 è¡Œ

Total: ~1075 è¡Œæ ¸å¿ƒä»£ç  (ç®€åŒ–å‰: 1380 è¡Œ)
å‡å°‘: 305 è¡Œ (-22%)
```

**ä¸»è¦å˜åŒ–**:
- `planner.py`: ä» 380 è¡Œå‡å°‘åˆ° 142 è¡Œï¼ˆç§»é™¤ Intentã€IntentRecognizerã€WorkflowPlannerï¼‰
- `prompts.py`: ä» 180 è¡Œå‡å°‘åˆ° 113 è¡Œï¼ˆç§»é™¤ QUERY/ANALYSIS ç›¸å…³æç¤ºè¯ï¼‰

### æµ‹è¯•æ–‡ä»¶

```
test/
â”œâ”€â”€ test_device_control_planner.py  # è®¾å¤‡æ§åˆ¶è§„åˆ’å™¨æµ‹è¯• (262 è¡Œ) - æ–°å¢
â”œâ”€â”€ test_context_manager.py         # ä¸Šä¸‹æ–‡ç®¡ç†å™¨æµ‹è¯• (ä¿ç•™)
â””â”€â”€ test_error_handler.py            # é”™è¯¯å¤„ç†å™¨æµ‹è¯• (ä¿ç•™)
```

### æ–‡æ¡£

```
solution/
â”œâ”€â”€ 02-agent-planning.md            # åŸå§‹éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ 05-intent-mapper.md             # Intent Mapper å®ç°æ–‡æ¡£
â””â”€â”€ 06-agent-implementation.md      # æœ¬æ–‡æ¡£ (ç®€åŒ–åçš„ Agent å®ç°)
```

---

## ä¸æ–‡æ¡£è¦æ±‚çš„å¯¹åº”å…³ç³»

### 02-agent-planning.md è¦æ±‚ â†’ ç®€åŒ–åå®ç°

| æ–‡æ¡£ç« èŠ‚ | åŸå§‹è¦æ±‚ | ç®€åŒ–åå®ç° | çŠ¶æ€ |
|---------|---------|----------|------|
| ç³»ç»Ÿæ¶æ„è®¾è®¡ â†’ ä¸‰å±‚æ¶æ„ | Context/Planning/Execution | prompts.py, planner.py, client.py | âœ… ç®€åŒ– |
| Prompt Engineering | System Prompt + Tool Descriptions | prompts.py (AGENT_SYSTEM_PROMPT - è®¾å¤‡æ§åˆ¶ä¸“ç”¨) | âœ… |
| å†³ç­–æ ‘è®¾è®¡ | Intent åˆ†ç±» + Workflow è§„åˆ’ | âŒ ç§»é™¤ (æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯è®¾å¤‡æ§åˆ¶) | âœ… ç®€åŒ– |
| è®¾å¤‡æ§åˆ¶è§„åˆ’ | - | planner.py (DeviceControlPlanner) | âœ… æ–°å¢ |
| ä¸Šä¸‹æ–‡æ„ŸçŸ¥è§„åˆ’ | Short-Term Memory | context_manager.py (ConversationContext) | âœ… ä¿ç•™ |
| å¹¶è¡Œä¸ä¸²è¡Œæ‰§è¡Œ | æ™ºèƒ½å†³ç­– | planner.py (should_use_batch) | âœ… ä¿ç•™ |
| é”™è¯¯å¤„ç†ä¸æ¢å¤ | Fallback ç­–ç•¥ | error_handler.py (ErrorHandler) | âœ… ä¿ç•™ |
| æ€§èƒ½ä¼˜åŒ– | Token å‡å°‘ã€ç¼“å­˜ | client.py + context_manager.py | âœ… ä¿ç•™ |
| å®æ–½æ£€æŸ¥æ¸…å• | 8 é¡¹è¦æ±‚ | ç®€åŒ–ä¸º 7 é¡¹ | âœ… 7/7 |

**ç®€åŒ–è¯´æ˜**:
- âŒ **ç§»é™¤**: Intent enumã€IntentRecognizerã€WorkflowPlannerï¼ˆ-238 è¡Œä»£ç ï¼‰
- âœ… **æ–°å¢**: DeviceControlPlanner ä¸“æ³¨äºè®¾å¤‡æ§åˆ¶è§£æ
- âœ… **ä¿ç•™**: Context Managerã€Error Handler æ ¸å¿ƒåŠŸèƒ½ä¸å˜
- âœ… **ç®€åŒ–**: System Prompt ä¸“æ³¨äºè®¾å¤‡æ§åˆ¶å·¥ä½œæµ

---

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒæˆå°±ï¼ˆç®€åŒ–åï¼‰

1. **ç®€åŒ–çš„ä¸‰å±‚æ¶æ„**
   - Context Layer: å¯ç¼“å­˜çš„ç³»ç»Ÿæç¤ºè¯ï¼ˆè®¾å¤‡æ§åˆ¶ä¸“ç”¨ï¼‰
   - Planning Layer: è½»é‡çº§è®¾å¤‡æ§åˆ¶è§„åˆ’ï¼ˆDeviceControlPlannerï¼‰
   - Execution Layer: ç»Ÿä¸€çš„ 3 æ­¥å·¥ä½œæµï¼ˆsearch â†’ interpret â†’ executeï¼‰

2. **ä¸“æ³¨çš„è®¾å¤‡æ§åˆ¶è§„åˆ’**
   - âœ… è®¾å¤‡æŸ¥è¯¢æå–ï¼ˆä»è‡ªç„¶è¯­è¨€ä¸­æå–è®¾å¤‡ä¿¡æ¯ï¼‰
   - âœ… å¤šè®¾å¤‡æ£€æµ‹ï¼ˆå¹¶è¡Œ vs æ‰¹å¤„ç†å†³ç­–ï¼‰
   - âœ… å‘½ä»¤è§£é‡Šéœ€æ±‚åˆ¤æ–­ï¼ˆæ˜ç¡® vs æ¨¡ç³Šå‘½ä»¤ï¼‰
   - âŒ ç§»é™¤ä¸å¿…è¦çš„æ„å›¾åˆ†ç±»ï¼ˆæ‰€æœ‰è¯·æ±‚éƒ½æ˜¯è®¾å¤‡æ§åˆ¶ï¼‰

3. **ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½**
   - æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆè®¾å¤‡ç¼“å­˜ã€çŠ¶æ€ç¼“å­˜ã€ä»£è¯å¼•ç”¨ï¼‰
   - å¼ºå¤§çš„é”™è¯¯å¤„ç†ï¼ˆ6 ç§é”™è¯¯ç±»å‹ã€é™çº§ç­–ç•¥ï¼‰
   - æ€§èƒ½ä¼˜åŒ–ï¼ˆPrompt Cachingã€ä¸Šä¸‹æ–‡ç¼“å­˜ï¼‰

4. **å…¨é¢çš„æµ‹è¯•è¦†ç›–**
   - 5 ä¸ªè®¾å¤‡æ§åˆ¶è§„åˆ’æµ‹è¯•åœºæ™¯
   - æ‰€æœ‰æµ‹è¯•é€šè¿‡
   - éªŒè¯ç®€åŒ–åçš„æ ¸å¿ƒèƒ½åŠ›

5. **æ˜¾è‘—çš„ä»£ç ç®€åŒ–**
   - å‡å°‘ 305 è¡Œä»£ç ï¼ˆ-22%ï¼‰
   - planner.py: 380 è¡Œ â†’ 142 è¡Œï¼ˆ-238 è¡Œï¼‰
   - prompts.py: 180 è¡Œ â†’ 113 è¡Œï¼ˆ-67 è¡Œï¼‰
   - æ›´æ˜“ç»´æŠ¤å’Œç†è§£

### ğŸ“Š æ•°æ®æŒ‡æ ‡ï¼ˆç®€åŒ–å‰åå¯¹æ¯”ï¼‰

| æŒ‡æ ‡ | ç®€åŒ–å‰ | ç®€åŒ–å | å˜åŒ– |
|-----|-------|-------|------|
| **æ ¸å¿ƒä»£ç è¡Œæ•°** | ~1380 è¡Œ | ~1075 è¡Œ | -305 è¡Œ (-22%) |
| **æ„å›¾ç±»å‹** | 5 ç§ | 0 ç§ | ä¸“æ³¨è®¾å¤‡æ§åˆ¶ |
| **å·¥ä½œæµæ¨¡å¼** | 9 ç§ | 1 ç§ç»Ÿä¸€æµç¨‹ | ç®€åŒ– 89% |
| **æµ‹è¯•åœºæ™¯** | 7 ä¸ª | 5 ä¸ª | ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½ |
| **æ–‡æ¡£å®Œæˆåº¦** | 100% | 100% | ä¿æŒ |
| **éœ€æ±‚å®Œæˆåº¦** | 8/8 æ£€æŸ¥é¡¹ | 7/7 æ£€æŸ¥é¡¹ | 100% |

### ğŸ”„ ç®€åŒ–å†³ç­–

**ä¸ºä»€ä¹ˆç®€åŒ–**:
- æ‰€æœ‰ç”¨æˆ·è¯·æ±‚éƒ½æ˜¯è®¾å¤‡æ§åˆ¶å‘½ä»¤
- æ— éœ€å¤æ‚çš„æ„å›¾åˆ†ç±»ï¼ˆCONTROL/QUERY/ANALYSIS/DISCOVERY/CONDITIONALï¼‰
- MCP server çš„ `interpret_command` å·¥å…·å·²å¤„ç†æ¨¡ç³Šå‘½ä»¤è§£æ
- å‡å°‘ä¸å¿…è¦çš„å¤æ‚åº¦ï¼Œæé«˜å¯ç»´æŠ¤æ€§

**ä¿ç•™çš„æ ¸å¿ƒä»·å€¼**:
- âœ… è®¾å¤‡æŸ¥è¯¢æå–å’Œå¤šè®¾å¤‡æ£€æµ‹
- âœ… å‘½ä»¤è§£é‡Šéœ€æ±‚æ™ºèƒ½åˆ¤æ–­
- âœ… ä¸Šä¸‹æ–‡ç®¡ç†å’Œè®¾å¤‡ç¼“å­˜
- âœ… é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆPrompt Cachingï¼‰

### ğŸš€ ä¸‹ä¸€æ­¥

ç®€åŒ–çš„ Agent ç³»ç»Ÿå·²å®Œæˆï¼Œå¯ä»¥ï¼š

1. **é›†æˆåˆ°ç”Ÿäº§ç¯å¢ƒ**
   - è¿æ¥å®é™…çš„ MCP æœåŠ¡å™¨
   - ä¸ Claude API é›†æˆ
   - éƒ¨ç½²ä¸ºæ™ºèƒ½å®¶å±…æ§åˆ¶æœåŠ¡

2. **åŠŸèƒ½å¢å¼º**
   - é›†æˆ intent_mapper å¤„ç†æ›´å¤šæ¨¡ç³Šå‘½ä»¤
   - æ”¯æŒæ›´å¤æ‚çš„å¤šè®¾å¤‡åœºæ™¯
   - ä¼˜åŒ–è®¾å¤‡æœç´¢ç®—æ³•

3. **ä¼˜åŒ–æå‡**
   - æ·»åŠ ç”¨æˆ·åå¥½å­¦ä¹ 
   - å¤šè¯­è¨€æ”¯æŒï¼ˆEnglish/ä¸­æ–‡ï¼‰
   - æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0 (ç®€åŒ–ç‰ˆ)
**ä½œè€…**: Claude (SmartThings MCP Expert)
**æœ€åæ›´æ–°**: 2025-11-14
**å˜æ›´**: ä»å¤æ‚çš„5æ„å›¾ç³»ç»Ÿç®€åŒ–ä¸ºä¸“æ³¨è®¾å¤‡æ§åˆ¶çš„å•ä¸€å·¥ä½œæµç³»ç»Ÿ
